---
import "../styles/global.css";
import About from "../components/About.astro";
import FavouriteFilms from "../components/FavouriteFilms.astro";
import FavouriteBooks from "../components/FavouriteBooks.astro";
import MusicActivity from "../components/MusicActivity.astro";
import Goals from "../components/Goals.astro";
import FavouriteAlbums from "../components/FavouriteAlbums.astro";
import FavouriteTracks from "../components/FavouriteTracks.astro";
import FavouritePerformances from "../components/FavouritePerformances.astro";
import FavouriteSets from "../components/FavouriteSets.astro";
import FavouriteVideos from "../components/FavouriteVideos.astro";
import FavouritePodcasts from "../components/FavouritePodcasts.astro";
import BlogPosts from "../components/BlogPosts.astro";
import Projects from "../components/Projects.astro";
import DarkBackdrop from "../components/DarkBackdrop.astro";
import { Image } from "astro:assets";

import myImage from "../assets/main.jpg";

interface LastFmTrackData {
    name: string;
    artist: { "#text": string };
    image: { size: string; "#text": string }[];
    url: string;
    "@attr"?: { nowplaying?: string };
}

interface MusicActivityProps {
    track: {
        name: string;
        artist: string;
        albumArt: string | null;
        url: string;
        nowPlaying: boolean;
    } | null;
    statusText: string | null;
}

let lastFmData: MusicActivityProps = { track: null, statusText: null };

const apiKey = import.meta.env.LASTFM_API_KEY;
const username = import.meta.env.LASTFM_USERNAME;

if (!apiKey || !username) {
    console.error(
        "Last.fm API key or username missing in environment variables.",
    );
    lastFmData.statusText = "Server Misconfiguration";
} else {
    const endpoint = `https://ws.audioscrobbler.com/2.0/?method=user.getrecenttracks&user=${username}&api_key=${apiKey}&format=json&limit=1`;
    try {
        const res = await fetch(endpoint);
        if (!res.ok) {
            throw new Error(
                `Last.fm API error: ${res.statusText} (Status: ${res.status})`,
            );
        }
        const data = await res.json();

        if (
            data.recenttracks &&
            data.recenttracks.track &&
            data.recenttracks.track.length > 0
        ) {
            const trackData: LastFmTrackData = data.recenttracks.track[0];
            const albumArt = trackData.image.find(
                (img) => img.size === "medium",
            );
            const isNowPlaying = trackData["@attr"]?.nowplaying === "true";

            lastFmData.track = {
                name: trackData.name,
                artist: trackData.artist["#text"],
                albumArt: albumArt ? albumArt["#text"] : null,
                url: trackData.url,
                nowPlaying: isNowPlaying,
            };
            lastFmData.statusText = isNowPlaying
                ? "Now Playing"
                : "Last Played";
        } else {
            lastFmData.statusText = "No Recent Tracks";
        }
    } catch (error) {
        console.error("Failed to fetch Last.fm data:", error);
        // Use error message if available, otherwise default
        lastFmData.statusText =
            error instanceof Error ? error.message : "API Fetch Error";
    }
}
---

<html class="overflow-x-hidden">
    <head>
        <title>Vandam Dinh</title>
        <meta name="description" content="Vandam Dinh's personal website" />
        <meta name="application-name" content="Vandam Dinh" />
        <meta name="apple-mobile-web-app-title" content="Vandam Dinh" />
        <meta name="apple-mobile-web-app-status-bar-style" content="default" />
        <meta name="og:title" content="Vandam Dinh" />
        <meta name="og:description" content="Vandam Dinh's personal website" />
        <meta name="og:image" content="/og.png" />
        <meta name="og:image:width" content="2400" />
        <meta name="og:image:height" content="1260" />
        <meta name="og:url" content="https://vandamdinh.com" />
        <meta name="og:site_name" content="Vandam Dinh" />
        <meta name="og:type" content="website" />
        <meta name="twitter:card" content="summary_large_image" />
        <meta name="twitter:title" content="Vandam Dinh" />
        <meta
            name="twitter:description"
            content="Vandam Dinh's personal website"
        />
        <meta name="twitter:image" content="/og.png" />
        <meta name="twitter:image:width" content="2400" />
        <meta name="twitter:image:height" content="1260" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link rel="icon" type="image/jpg" href="/me.jpg" />
        <meta charset="utf-8" />
    </head>

    <body class="overflow-x-hidden bg-[#15181D]">
        <DarkBackdrop />

        <header
            class="absolute top-0 left-0 z-10 flex h-[79px] w-full items-center bg-transparent px-[5%] lg:px-[15%]"
        >
            <div
                class="flex w-full flex-col items-center justify-between gap-4 pt-10 lg:flex-row lg:pt-0"
            >
                <a href="/"
                    ><img
                        src="/logo.svg"
                        alt="Vandam Dinh"
                        class="h-7 w-auto"
                    /></a
                >
                <div class="flex flex-row items-center gap-10 lg:gap-4">
                    <a
                        href="https://github.com/vandamd"
                        target="_blank"
                        rel="noopener noreferrer"
                        class="font-semibold text-[#D7E0E8] uppercase hover:text-white"
                        >GitHub</a
                    >

                    <a href="mailto:hi@vandamdinh.com">
                        <button
                            class="ml-2 flex cursor-pointer flex-row items-center gap-1 rounded-sm border-t border-[#68CB6A]/70 bg-[#06AC1D] px-2 py-[1.2px] pr-3 font-semibold text-white uppercase hover:bg-[#009D1B]"
                        >
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                width="20"
                                height="20"
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="currentColor"
                                stroke-width="2.5"
                                class="lucide lucide-plus-icon lucide-plus"
                                ><path d="M5 12h14"></path><path d="M12 5v14"
                                ></path></svg
                            >
                            Mail
                        </button>
                    </a>
                </div>
            </div>
        </header>

        <Image
            src={myImage}
            transition:name="fade"
            alt="Vandam Dinh"
            class="fade-in-image pointer-events-none absolute top-0 left-0 z-0 h-[800px] w-full -translate-y-[220px] mask-t-from-80% mask-x-from-73% mask-x-to-93% mask-b-to-70% mask-intersect object-cover lg:-translate-y-[80px]"
        />

        <div
            class="flex h-full w-full flex-row items-center justify-center px-[10%] pt-60 lg:px-[0%] lg:pt-90"
        >
            <h1
                class="fade-in-delayed text-center text-xl font-extralight text-[#99AABB] lg:text-3xl"
            >
                Welcome to my website, <span
                    class="text-white underline decoration-[#99AABB]/40 decoration-1 underline-offset-6"
                    >friend</span
                >. Here's a little about me...
            </h1>
        </div>

        <div
            class="fade-in-delayed-2 z-10000 w-full overflow-x-hidden px-[5%] pt-10 pb-60 lg:px-[15%]"
        >
            <div class="flex flex-col gap-8 lg:flex-row lg:gap-12">
                <div class="lg:w-[70%]">
                    <div class="flex flex-col gap-8">
                        <About />
                        <div class="lg:hidden">
                            <Goals />
                        </div>
                        <div class="lg:hidden">
                            <Projects />
                        </div>
                        <FavouriteFilms />
                        <FavouriteBooks />
                        <FavouriteAlbums />
                        <FavouriteTracks />
                        <FavouritePerformances />
                        <FavouriteSets />
                        <FavouriteVideos />
                        <FavouritePodcasts />
                        <div class="lg:hidden">
                            <BlogPosts />
                        </div>
                    </div>
                </div>

                <div class="order-first lg:order-last lg:w-[30%]">
                    <div class="flex flex-col gap-8">
                        <MusicActivity
                            track={lastFmData.track}
                            statusText={lastFmData.statusText}
                        />
                        <div class="hidden lg:block">
                            <Goals />
                        </div>
                        <div class="hidden lg:block">
                            <Projects />
                        </div>
                        <div class="hidden lg:block">
                            <BlogPosts />
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </body>
</html>
